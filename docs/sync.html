<!DOCTYPE html>  <html> <head>   <title>sync.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="calendar.html">                 calendar.coffee               </a>                                           <a class="source" href="collection.html">                 collection.coffee               </a>                                           <a class="source" href="controller.html">                 controller.coffee               </a>                                           <a class="source" href="form.html">                 form.coffee               </a>                                           <a class="source" href="grid.html">                 grid.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="list.html">                 list.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="notifications.html">                 notifications.coffee               </a>                                           <a class="source" href="sync.html">                 sync.coffee               </a>                                           <a class="source" href="view.html">                 view.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               sync.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>this class reads model attributes and decides whether or not they should be stored locally</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Sync</span>
  </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>overrides backbone.sync</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nv">Backbone.sync = </span><span class="nx">@backbone</span>
    <span class="k">this</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>gets change events from models as they happen.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">changed: </span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span>
    
        </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>this method overrides backbone.sync</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">backbone: </span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>  
      
    <span class="nv">model.url = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="k">then</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span> <span class="k">else</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">options = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">options</span>
    <span class="nv">model.collection = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span>
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>check to be sure somewhere to store the models has been specified</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">and</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">url</span> <span class="o">and</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">localstore</span> <span class="o">and</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">localstore</span> <span class="o">and</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">localstore</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s">&#39;A url or localstore property must be defined to use Storage.sync!&#39;</span><span class="p">)</span>
        </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>BIG OL' TODO
check to see if we should use localstore. objects should be stored, but not read from local if the app is online
if options.localstore or model.localstore or model.collection.localstore
app.log('got localstore!')
 if method is not 'read' and app.isOnline
  @local(method, model, options)</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>sync the object up to the server if the application is online</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span> <span class="o">or</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">and</span> <span class="nx">app</span><span class="p">.</span><span class="nx">isOnline</span> 
      <span class="nx">@server</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
     
  
  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>pushes objects to local store</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">local: </span><span class="nf">(method, model, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>app.log('local called' + model.localstore)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">switch</span> <span class="nx">method</span>
      <span class="k">when</span> <span class="s">&#39;read&#39;</span> <span class="k">then</span> <span class="nx">app</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;read shit!&#39;</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;create&#39;</span> <span class="k">then</span> <span class="nx">app</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;create shit!&#39;</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;delete&#39;</span> <span class="k">then</span> <span class="nx">app</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;update shit!&#39;</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;delete&#39;</span> <span class="k">then</span> <span class="nx">app</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;delete shit!&#39;</span><span class="p">)</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>backbone .sync default server coms         </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">server: </span><span class="nf">(method, model, options) -&gt;</span>
    
    <span class="nv">methodMap =</span>
      <span class="s">&#39;create&#39;</span><span class="o">:</span> <span class="s">&#39;POST&#39;</span>
      <span class="s">&#39;update&#39;</span><span class="o">:</span> <span class="s">&#39;PUT&#39;</span>
      <span class="s">&#39;delete&#39;</span><span class="o">:</span> <span class="s">&#39;DELETE&#39;</span>
      <span class="s">&#39;read&#39;</span><span class="o">:</span>   <span class="s">&#39;GET&#39;</span>
        
    <span class="nv">type = </span><span class="nx">methodMap</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>  
    <span class="nv">options = </span><span class="p">{}</span> <span class="nx">unless</span> <span class="nx">options</span>
    
    <span class="nv">params =</span>
      <span class="nv">type: </span><span class="nx">type</span>
      <span class="nx">dataType</span><span class="o">:</span><span class="s">&#39;json&#39;</span>
              
    <span class="nv">params.url = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="k">then</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="k">else</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span>
    
    <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="o">and</span> <span class="nx">model</span> <span class="o">and</span> <span class="p">(</span><span class="nx">method</span> <span class="o">is</span> <span class="s">&#39;create&#39;</span> <span class="o">or</span> <span class="nx">method</span> <span class="o">is</span> <span class="s">&#39;update&#39;</span> <span class="o">or</span> <span class="nx">method</span> <span class="o">is</span> <span class="s">&#39;delete&#39;</span><span class="p">)</span>
      <span class="nv">params.contentType = </span><span class="s">&#39;application/json&#39;</span>    
      <span class="nv">params.data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateHTTP</span>
      <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;PUT&#39;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;DELETE&#39;</span>
        <span class="k">if</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span>
          <span class="nv">params.data_method = </span><span class="nx">type</span>
        <span class="nv">params.type = </span><span class="s">&#39;POST&#39;</span>
        <span class="nx">params</span><span class="p">.</span><span class="nx">beforeSend</span> <span class="nf">(xhr) -&gt;</span>
          <span class="nx">xhr</span><span class="p">.</span><span class="nx">sendRequestHeader</span><span class="p">(</span><span class="s">&#39;X-HTTP-Method-Override&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s">&#39;GET&#39;</span> <span class="o">and</span> <span class="o">!</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span>
      <span class="nv">params.processData = </span><span class="kc">false</span>
      
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">options</span><span class="p">))</span>
    <span class="k">this</span>
  
   
  <span class="nv">ajax: </span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>todo - this should serve as both cache and update in the future for local use.
hijack the success return object for storage -</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nv">params.url = </span><span class="nx">url</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">))</span>
    <span class="k">this</span>
    
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>todo - methods used to interface with the local store</p>             </td>             <td class="code">               <div class="highlight"><pre>  
    
  

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 